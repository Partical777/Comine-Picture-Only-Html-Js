<!DOCTYPE html>
<html>
    <head>
        <title>Coat of Arms Generater</title>
        <meta charset="UTF-8" />

        <script src="https://unpkg.com/konva@3.4.1/konva.min.js"></script>
        <link rel="stylesheet" type="text/css" href="./src/styles.css" />
    </head>

    <body>
        <p>
            Drag&drop yoda into the grey area.
        </p>
        <div id="drag-items">
            <img
                src="https://partical777.github.io/Comine-Picture-Only-Html-Js/img/1-1.png"
                draggable="true"
            />
            <img
                src="https://partical777.github.io/Comine-Picture-Only-Html-Js/img/1-2.png"
                draggable="true"
            />
            <img
                src="https://partical777.github.io/Comine-Picture-Only-Html-Js/img/1-3.png"
                draggable="true"
            />
            <img
                src="https://partical777.github.io/Comine-Picture-Only-Html-Js/img/1-4.png"
                draggable="true"
            />
        </div>
        <div id="container"></div>
        <script>
            let width = 750;
            let height = 750;
            let imagewh = 210; //half 420
            let trStyle = {
                //transform Style
                anchorStroke: "#fc766a",
                anchorSize: 25,
                borderStroke: "#fc766a",
                borderStrokeWidth: 5,
                anchorCornerRadius: 50
            };

            let stage = new Konva.Stage({
                container: "container",
                width: width,
                height: height
            });
            let layer = new Konva.Layer();
            let Background = new Konva.Rect({
                x: 0,
                y: 0,
                width: width,
                height: height
            });

            layer.add(Background);

            let ImageGroup = new Konva.Group();

            //     Drag & Drop Image
            // what is url of dragging element?
            let itemURL = "";
            document
                .getElementById("drag-items")
                .addEventListener("dragstart", function(e) {
                    itemURL = e.target.src;
                });

            let con = stage.container();
            con.addEventListener("dragover", function(e) {
                e.preventDefault(); // !important
            });

            con.addEventListener("drop", function(e) {
                e.preventDefault();
                // now we need to find pointer position
                // we can't use stage.getPointerPosition() here, because that event
                // is not registered by Konva.Stage
                // we can register it manually:
                stage.setPointersPositions(e);

                Konva.Image.fromURL(itemURL, function(image) {
                    ImageGroup.add(image);
                    stage.getPointerPosition().x -= imagewh;
                    stage.getPointerPosition().y -= imagewh;

                    image.position(stage.getPointerPosition());
                    image.draggable(true);

                    layer.add(ImageGroup);

                    let tr = new Konva.Transformer(trStyle);
                    ImageGroup.add(tr);
                    detachAll();
                    tr.attachTo(
                        ImageGroup.children[ImageGroup.children.length - 2]
                    );

                    layer.draw();
                });
            });
            //=====Drag & Drop Image

            //Event
            ImageGroup.on("mouseover", function(evt) {
                let shape = evt.target;
                document.body.style.cursor = "move";
                shape.stroke("#fc766a");
                layer.draw();
            });
            ImageGroup.on("mouseout", function(evt) {
                let shape = evt.target;
                document.body.style.cursor = "default";
                shape.stroke("");
                layer.draw();
            });
            ImageGroup.on("click", function(evt) {
                let shape = evt.target;

                detachAll();
                attachNew(shape.index);
                layer.draw();
            });
            ImageGroup.on("dragmove", function(evt) {
                let shape = evt.target;

                detachAll();
                attachNew(shape.index);
                layer.draw();
            });
            Background.on("click", function(evt) {
                //click background to get blur
                let shape = evt.target;
                detachAll();
                layer.draw();
            });
            //=====Event

            function detachAll() {
                //detach all others
                ImageGroup.children.forEach(function(el) {
                    //Array in ImageGroup is like => [n, t, n, t...]
                    el.index % 2 ? ImageGroup.children[el.index].detach() : 0;
                });
            }

            function attachNew(tar) {
                ImageGroup.children[tar + 1].attachTo(ImageGroup.children[tar]);
            }

            stage.add(layer);
        </script>

        <!-- <div align="center">
            <img
                src="https://partical777.github.io/Comine-Picture-Only-Html-Js/img/1-1.png"
                width="300"
            />
            <img
                src="https://partical777.github.io/Comine-Picture-Only-Html-Js/img/1-2.png"
                width="300"
            />
            <img
                src="https://partical777.github.io/Comine-Picture-Only-Html-Js/img/1-3.png"
                width="300"
            />
            <img
                src="https://partical777.github.io/Comine-Picture-Only-Html-Js/img/1-4.png"
                width="300"
            />
        </div>
        <div id="imgBox1" align="center">
            <input type="button" value="一鍵合成" id="combineMe1" />
        </div>

</br>
</br>
</br>

        <div align="center">
            <img
                src="https://partical777.github.io/Comine-Picture-Only-Html-Js/img/2-1.png"
                width="300"
            />
            <img
                src="https://partical777.github.io/Comine-Picture-Only-Html-Js/img/2-2.png"
                width="300"
            />
            <img
                src="https://partical777.github.io/Comine-Picture-Only-Html-Js/img/2-3.png"
                width="300"
            />
            <img
                src="https://partical777.github.io/Comine-Picture-Only-Html-Js/img/2-4.png"
                width="300"
            />
            <img
                src="https://partical777.github.io/Comine-Picture-Only-Html-Js/img/2-5.png"
                width="300"
            />
            <img
                src="https://partical777.github.io/Comine-Picture-Only-Html-Js/img/2-6.png"
                width="300"
            />
        </div>
        <div id="imgBox2" align="center">
            <input type="button" value="一鍵合成" id="combineMe2" />
        </div>

        <script src="src/index.js"></script> -->
    </body>
</html>
